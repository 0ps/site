(function(e) {
    e("#tags").selectize({
        maxItems: 5
    });
    e("#categories").selectize({
        maxItems: 5
    });

    ace.require("ace/ext/language_tools");
    var editor = ace.edit("content");
    var textarea = $('#input').hide();
    var preview = $('#output');
    var phpMode = ace.require("ace/mode/php").Mode;

    editor.setTheme("ace/theme/github");
    editor.getSession().setMode(new phpMode());
    editor.getSession().setValue(textarea.val());
    editor.setOptions({
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: false
    });

    var cachedContent = localStorage.content || '';
    var cachedTitle = localStorage.title || '';

    if (cachedContent && !editor.getSession().getValue().length) {
      editor.getSession().setValue(cachedContent);
    };

    if (cachedTitle) {
    $('[name=title]').val(cachedTitle);
    };

    $('[name=title]').on('change', function(){
    localStorage.title = $(this).val();
    });

    editor.getSession().on('change', function(){
    var content = editor.getSession().getValue();
    textarea.val(content);
    textarea.change();
    preview.html(marked(content));
    localStorage.content=content;
    });

    function update() {
      var shouldShow = !editor.session.getValue().length;
      var node = editor.renderer.emptyMessageNode;

      if (!shouldShow && node) {
          editor.renderer.scroller.removeChild(editor.renderer.emptyMessageNode);
          editor.renderer.emptyMessageNode = null;
      } else if (shouldShow && !node) {
          node = editor.renderer.emptyMessageNode = document.createElement("div");
          node.textContent = "请使用 markdown 格式编写"
          node.className = "ace_invisible ace_emptyMessage"
          node.style.padding = "0 9px";
          node.style.position = "absolute";
          node.style.zIndex = 99999;
          editor.renderer.scroller.insertBefore(node, editor.renderer.scroller.firstChild);
      }
    }
    update();
    editor.on("input", update);

    $('form').on('submit', function(){
    localStorage.content = '';
    localStorage.title = '';
    });

    // tabs
    $('.nav-tabs a').click(function (e) {
    e.preventDefault()
    $(this).tab('show');
    if ($(this).attr('href') == '#output-wrapper') {
      Prism.highlightAll();
    };
    });

    //sync scroll
    $('#input').scroll(function(event) {
    var $input = $(this);
    var $output = $('#output');

    var $scale = $input.scrollTop() / ($input.get(0).scrollHeight - $input.get(0).offsetHeight);

    $output.scrollTop(parseInt(($output.get(0).scrollHeight - $output.get(0).offsetHeight) * $scale));
    });
})(jQuery)